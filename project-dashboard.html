<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Dashboard - BRD Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.40/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        /* Conflict Option Cards */
        .conflict-option {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .conflict-option:hover {
            background-color: #F9FAFB;
        }
        .conflict-option.selected {
            background-color: #EFF6FF;
            border-color: #2563EB !important;
            border-width: 2px !important;
        }
        
        /* Editable Fields */
        .editable-field {
            padding: 10px 14px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            transition: all 0.2s ease;
            background-color: white;
            font-size: 14px;
        }
        .editable-field:hover {
            border-color: #D1D5DB;
            background-color: #F9FAFB;
        }
        .editable-field:focus {
            outline: none;
            border-color: #2563EB;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Platform Sidebar - Read Only */
        .platform-sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #E5E7EB;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .platform-section {
            border-bottom: 1px solid #F3F4F6;
        }
        
        .platform-header {
            padding: 14px 16px;
            background-color: #F9FAFB;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: default;
        }
        
        .platform-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .platform-name {
            font-size: 14px;
            font-weight: 500;
            color: #111827;
            flex: 1;
        }
        
        .status-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            background-color: #F3F4F6;
            color: #6B7280;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .status-badge.connected {
            background-color: #D1FAE5;
            color: #065F46;
        }
        
        .chat-item-readonly {
            padding: 10px 16px 10px 56px;
            font-size: 13px;
            color: #4B5563;
            border-bottom: 1px solid #F9FAFB;
            background-color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-icon {
            width: 16px;
            color: #9CA3AF;
            font-size: 12px;
        }
        
        /* Main layout */
        .main-with-sidebar {
            display: flex;
            height: calc(100vh - 8rem);
            overflow: hidden;
        }
        
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        @media (max-width: 1023px) {
            .main-with-sidebar {
                flex-direction: column;
            }
            
            .platform-sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid #E5E7EB;
            }
        }

        /* MDX Content Styling */
        .mdx-content {
            line-height: 1.8;
            color: #1f2937;
        }

        .mdx-h1 {
            font-size: 2em;
            font-weight: 700;
            margin: 1.5em 0 0.5em 0;
            color: #111827;
            border-bottom: 3px solid #2563EB;
            padding-bottom: 0.5em;
        }

        .mdx-h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 1.3em 0 0.6em 0;
            color: #1f2937;
            border-left: 4px solid #2563EB;
            padding-left: 1em;
        }

        .mdx-h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin: 1em 0 0.5em 0;
            color: #374151;
        }

        .mdx-p {
            margin: 0.8em 0;
            font-size: 0.95em;
        }

        .mdx-bold {
            font-weight: 600;
            color: #111827;
        }

        .mdx-italic {
            font-style: italic;
            color: #4b5563;
        }

        .mdx-ul {
            list-style-type: disc;
            margin-left: 2em;
            margin-bottom: 1em;
        }

        .mdx-li {
            margin: 0.4em 0;
            font-size: 0.95em;
        }

        .mdx-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .mdx-table td {
            padding: 12px;
            border: 1px solid #e5e7eb;
            font-size: 0.9em;
            text-align: left;
        }

        .mdx-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .mdx-table tr:first-child {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #111827;
        }

        .mdx-hr {
            border: none;
            border-top: 2px solid #d1d5db;
            margin: 2em 0;
        }

        /* Code block styling (if needed in future) */
        .mdx-code {
            background-color: #1f2937;
            color: #e5e7eb;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <!-- Top Navigation -->
    <nav class="bg-white border-b flex-shrink-0" style="border-color: #E5E7EB;">
        <div class="px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold" style="color: #2563EB;">BRD Generator</h1>
                <span class="text-sm hidden sm:inline" style="color: #6B7280;" id="projectTitle">Loading...</span>
            </div>
            <a href="user-dashboard.html" class="text-sm px-4 py-2 rounded-lg border" style="border-color: #E5E7EB; color: #6B7280;">
                ‚Üê Back
            </a>
        </div>
        
        <!-- Horizontal Steps Navigation -->
        <div class="border-t" style="border-color: #E5E7EB;">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between gap-2 sm:gap-4" id="stepsList">
                    <!-- Steps will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout with Platform Sidebar -->
    <div class="main-with-sidebar">
        <!-- Platform Sidebar - Read Only -->
        <div class="platform-sidebar" id="platformSidebar">
            <div class="p-4 border-b" style="border-color: #E5E7EB; background-color: #F9FAFB;">
                <h3 class="text-xs font-semibold uppercase tracking-wider" style="color: #6B7280;">DATA SOURCES</h3>
                <p class="text-xs mt-1" style="color: #9CA3AF;">Connected platforms used in this project</p>
            </div>
            <div id="platformList">
                <!-- Platforms will be loaded dynamically -->
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area" id="contentArea">
            <div id="stepContent">
                <!-- Step content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/dummyData.js"></script>
    <script src="js/extraction.js"></script>
    <script src="js/conflicts.js"></script>
    <script src="js/summary.js"></script>
    <script src="js/mdx-renderer.js"></script>
    <script src="js/pdf-exporter.js"></script>
    <script src="js/brd.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/router.js"></script>
    <script src="js/main.js"></script>
    <script src="js/platforms.js"></script>
    <script>
        let currentProject = null;
        let projectState = null;
        let testUserData = null;

        // Initialize
        async function init() {
            const projectId = Router.getParam('id');
            if (!projectId) {
                UI.showError('Error', 'Project ID not found');
                setTimeout(() => window.location.href = 'user-dashboard.html', 2000);
                return;
            }

            // Load project
            projectState = Storage.get(Storage.KEYS.PROJECT_PREFIX + projectId);
            if (!projectState) {
                UI.showError('Error', 'Project not found');
                setTimeout(() => window.location.href = 'user-dashboard.html', 2000);
                return;
            }

            currentProject = projectState.metadata;
            testUserData = DummyData.getUserData(currentProject.testUserId);
            
            if (!testUserData) {
                UI.showError('Error', 'Test user data not found');
                return;
            }

            document.getElementById('projectTitle').textContent = currentProject.name;

            // If step 1 not started, initialize it
            if (!projectState.extractionData || projectState.extractionData.length === 0) {
                await performStep1Extraction();
            }

            renderSteps();
            renderReadOnlyPlatformSidebar();
            renderCurrentStep();
        }

        // Render read-only platform sidebar for project dashboard
        function renderReadOnlyPlatformSidebar() {
            const platformList = document.getElementById('platformList');
            
            let html = '';

            // Gmail Section
            if (testUserData.data_vault.gmail) {
                const relevantGmails = testUserData.data_vault.gmail.filter(g => g.is_relevant);
                html += renderReadOnlyPlatformSection('gmail', 'Gmail', 'üìß', '#DC2626', relevantGmails, 'thread_id', 'subject', true);
            }

            // WhatsApp Section
            if (testUserData.data_vault.whatsapp) {
                const relevantWhatsApps = testUserData.data_vault.whatsapp.filter(w => w.is_relevant);
                html += renderReadOnlyPlatformSection('whatsapp', 'WhatsApp', 'üí¨', '#16A34A', relevantWhatsApps, 'thread_id', 'name', true);
            }

            // Slack Section
            if (testUserData.data_vault.slack) {
                const relevantSlacks = testUserData.data_vault.slack.filter(s => s.is_relevant);
                html += renderReadOnlyPlatformSection('slack', 'Slack', 'üíº', '#2563EB', relevantSlacks, 'channel_id', 'name', true);
            }

            // Meetings Section
            if (testUserData.data_vault.meetings) {
                html += renderReadOnlyPlatformSection('meetings', 'Meetings', 'üé§', '#EAB308', testUserData.data_vault.meetings, 'meeting_id', 'title', true);
            }

            // Proposal Section (if exists)
            if (testUserData.data_vault.proposal) {
                html += `
                    <div class="platform-section">
                        <div class="platform-header">
                            <div class="platform-icon" style="background-color: #6B728020; color: #6B7280;">üìÑ</div>
                            <span class="platform-name">Proposal</span>
                            <span class="status-badge connected">Connected</span>
                        </div>
                    </div>
                `;
            }

            platformList.innerHTML = html;
        }

        function renderReadOnlyPlatformSection(platform, name, icon, color, items, idField, nameField, isConnected) {
            return `
                <div class="platform-section">
                    <div class="platform-header">
                        <div class="platform-icon" style="background-color: ${color}20; color: ${color};">${icon}</div>
                        <span class="platform-name">${name}</span>
                        <span class="status-badge ${isConnected ? 'connected' : ''}">${isConnected ? 'Connected' : 'Not connected'}</span>
                    </div>
                    <div>
                        ${items.map(item => `
                            <div class="chat-item-readonly">
                                <span class="chat-icon">‚óè</span>
                                <span class="truncate">${item[nameField] || 'Untitled'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Perform Step 1 Extraction
        async function performStep1Extraction() {
            UI.showLoader('Extracting relevant facts from conversations...');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const facts = Extraction.extractFacts(testUserData);
            projectState.extractionData = facts;
            projectState.completedSteps = [1];
            projectState.currentStep = 1;
            
            saveProjectState();
            UI.hideLoader();
        }

        // Render steps in horizontal navigation
        function renderSteps() {
            const steps = [
                { num: 1, title: 'Extraction', desc: 'Data Extraction', icon: 'üìä' },
                { num: 2, title: 'Conflicts', desc: 'Conflict Detection', icon: '‚öîÔ∏è' },
                { num: 3, title: 'Summary', desc: 'Summary Review', icon: 'üìù' },
                { num: 4, title: 'BRD', desc: 'BRD Document', icon: 'üìÑ' }
            ];

            const stepsList = document.getElementById('stepsList');
            
            const html = steps.map((step, index) => {
                const isActive = projectState.currentStep === step.num;
                const isCompleted = projectState.completedSteps.includes(step.num);
                const isPending = !isActive && !isCompleted;
                
                let stepClass = 'flex items-center justify-center w-8 h-8 sm:w-10 sm:h-10 rounded-full text-sm sm:text-base font-semibold flex-shrink-0';
                let textClass = 'text-xs sm:text-sm font-medium';
                let connectorClass = 'flex-1 h-0.5 mx-1 sm:mx-2';
                
                if (isActive) {
                    stepClass += ' bg-blue-600 text-white';
                    textClass += ' text-blue-600';
                    connectorClass += ' bg-gray-200';
                } else if (isCompleted) {
                    stepClass += ' bg-green-500 text-white';
                    textClass += ' text-green-600';
                    connectorClass += ' bg-green-500';
                } else {
                    stepClass += ' bg-gray-100 text-gray-400 border border-gray-200';
                    textClass += ' text-gray-400';
                    connectorClass += ' bg-gray-200';
                }
                
                return `
                    <div class="flex items-center flex-1" onclick="viewStep(${step.num})" style="cursor: ${isPending ? 'not-allowed' : 'pointer'}; opacity: ${isPending ? '0.6' : '1'};">
                        <div class="flex flex-col items-center w-full">
                            <div class="flex items-center w-full">
                                <div class="${stepClass}">
                                    ${isCompleted ? '‚úì' : step.icon}
                                </div>
                                ${index < steps.length - 1 ? `<div class="${connectorClass}"></div>` : ''}
                            </div>
                            <div class="mt-2 text-center w-full">
                                <div class="${textClass} hidden sm:block">${step.desc}</div>
                                <div class="${textClass} sm:hidden">${step.title}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            stepsList.innerHTML = html;
        }

        // View step (if allowed)
        function viewStep(stepNum) {
            if (stepNum > projectState.currentStep && !projectState.completedSteps.includes(stepNum - 1)) {
                UI.showError('Step Locked', 'Please complete previous steps first.');
                return;
            }
            
            if (stepNum > projectState.currentStep && projectState.completedSteps.includes(stepNum - 1)) {
                projectState.currentStep = stepNum;
                saveProjectState();
                renderSteps();
                renderCurrentStep();
                return;
            }
            
            if (stepNum <= projectState.currentStep) {
                projectState.currentStep = stepNum;
                saveProjectState();
                renderSteps();
                renderCurrentStep();
            }
        }

        // Render current step content
        function renderCurrentStep() {
            const stepContent = document.getElementById('stepContent');
            
            switch(projectState.currentStep) {
                case 1:
                    renderStep1();
                    break;
                case 2:
                    renderStep2();
                    break;
                case 3:
                    renderStep3();
                    break;
                case 4:
                    renderStep4();
                    break;
            }
        }

        // ==================== STEP 1: EXTRACTION ====================
        function renderStep1() {
            const facts = projectState.extractionData || [];
            
            const html = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-2" style="color: #111827;">Step 1: Data Extraction</h2>
                    <p class="mb-6" style="color: #6B7280;">
                        ${facts.length} relevant facts extracted from conversations. Review and delete any incorrect facts.
                    </p>
                    
                    <div class="space-y-4" id="factsList">
                        ${facts.map(fact => `
                            <div class="bg-white rounded-lg shadow-sm p-5 border" style="border-color: #E5E7EB;">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs px-2 py-1 rounded-full" style="background-color: ${Extraction.getSourceColor(fact.source)}20; color: ${Extraction.getSourceColor(fact.source)};">
                                        ${Extraction.getSourceIcon(fact.source)} ${fact.sourceLabel}
                                    </span>
                                    <button onclick="deleteFact('${fact.id}')" class="text-xs" style="color: #DC2626;">Delete</button>
                                </div>
                                <p class="mb-2 text-sm" style="color: #111827;">${UI.escapeHtml(fact.content)}</p>
                                <p class="text-xs" style="color: #6B7280;">‚Äî ${fact.speaker}</p>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button onclick="completeStep1()" class="px-6 py-2.5 rounded-lg text-white text-sm font-medium" style="background-color: #2563EB;">
                            Continue to Conflict Detection ‚Üí
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('stepContent').innerHTML = html;
        }

        function deleteFact(factId) {
            UI.showConfirmation(
                'Delete Fact',
                'Are you sure you want to delete this fact?',
                () => {
                    projectState.extractionData = Extraction.deleteFact(projectState.extractionData, factId);
                    saveProjectState();
                    renderStep1();
                    UI.showSuccess('Deleted', 'Fact has been removed.');
                }
            );
        }

        async function completeStep1() {
            UI.showLoader('Analyzing conversations and detecting conflicts...');
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const conflicts = Conflicts.detectConflicts(projectState.extractionData);
            projectState.conflictsData = conflicts;
            
            if (!projectState.completedSteps.includes(1)) {
                projectState.completedSteps.push(1);
            }
            projectState.currentStep = 2;
            
            saveProjectState();
            UI.hideLoader();
            renderSteps();
            renderCurrentStep();
        }

        // ==================== STEP 2: CONFLICTS ====================
        function renderStep2() {
            const conflicts = projectState.conflictsData || [];
            
            if (conflicts.length === 0) {
                UI.showSuccess('No Conflicts', 'No conflicts detected. Moving to summary...');
                setTimeout(() => completeStep2(), 1500);
                return;
            }

            const allSelected = conflicts.every(c => c.selectedFactId !== null);
            
            const html = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-2" style="color: #111827;">Step 2: Conflict Detection</h2>
                    <p class="mb-6" style="color: #6B7280;">
                        ${conflicts.length} conflict${conflicts.length !== 1 ? 's' : ''} detected. Select your preferred option for each.
                    </p>
                    
                    <div class="space-y-5" id="conflictsList">
                        ${conflicts.map((conflict, index) => `
                            <div class="bg-white rounded-lg shadow-sm p-5 border" style="border-color: #E5E7EB;">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-xs px-2 py-1 rounded-full" style="background-color: ${Conflicts.getConflictTypeColor(conflict.type)}20; color: ${Conflicts.getConflictTypeColor(conflict.type)};">
                                        ${conflict.description}
                                    </span>
                                    <span class="text-xs" style="color: #6B7280;">${index + 1}/${conflicts.length}</span>
                                </div>

                                <!-- Option A -->
                                <div class="border rounded-lg p-4 mb-3 ${conflict.selectedFactId === conflict.factA.id ? 'selected' : ''}" 
                                     style="border-color: ${conflict.selectedFactId === conflict.factA.id ? '#2563EB' : '#E5E7EB'}; background-color: ${conflict.selectedFactId === conflict.factA.id ? '#EFF6FF' : 'white'};"
                                     onclick="selectConflictOption('${conflict.id}', '${conflict.factA.id}')">
                                    <div class="flex gap-3">
                                        <input type="radio" name="conflict_${conflict.id}" ${conflict.selectedFactId === conflict.factA.id ? 'checked' : ''} class="mt-1">
                                        <div>
                                            <div class="text-xs mb-2" style="color: ${Extraction.getSourceColor(conflict.factA.source)};">
                                                ${Extraction.getSourceIcon(conflict.factA.source)} ${conflict.factA.sourceLabel}
                                            </div>
                                            <p class="text-sm mb-1" style="color: #111827;">${UI.escapeHtml(conflict.factA.content)}</p>
                                            <p class="text-xs" style="color: #6B7280;">‚Äî ${conflict.factA.speaker}</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Option B -->
                                <div class="border rounded-lg p-4 mb-3 ${conflict.selectedFactId === conflict.factB.id ? 'selected' : ''}" 
                                     style="border-color: ${conflict.selectedFactId === conflict.factB.id ? '#2563EB' : '#E5E7EB'}; background-color: ${conflict.selectedFactId === conflict.factB.id ? '#EFF6FF' : 'white'};"
                                     onclick="selectConflictOption('${conflict.id}', '${conflict.factB.id}')">
                                    <div class="flex gap-3">
                                        <input type="radio" name="conflict_${conflict.id}" ${conflict.selectedFactId === conflict.factB.id ? 'checked' : ''} class="mt-1">
                                        <div>
                                            <div class="text-xs mb-2" style="color: ${Extraction.getSourceColor(conflict.factB.source)};">
                                                ${Extraction.getSourceIcon(conflict.factB.source)} ${conflict.factB.sourceLabel}
                                            </div>
                                            <p class="text-sm mb-1" style="color: #111827;">${UI.escapeHtml(conflict.factB.content)}</p>
                                            <p class="text-xs" style="color: #6B7280;">‚Äî ${conflict.factB.speaker}</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <textarea id="comment_${conflict.id}" rows="2" class="w-full px-3 py-2 text-sm border rounded-lg" style="border-color: #E5E7EB;" placeholder="Add reasoning (optional)">${conflict.comment || ''}</textarea>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button onclick="resolveAllConflicts()" 
                                ${!allSelected ? 'disabled' : ''}
                                class="px-6 py-2.5 rounded-lg text-white text-sm font-medium" 
                                style="background-color: ${allSelected ? '#16A34A' : '#9CA3AF'}; opacity: ${allSelected ? '1' : '0.6'}; cursor: ${allSelected ? 'pointer' : 'not-allowed'};">
                            ${allSelected ? 'Resolve All & Continue ‚Üí' : 'Select All Options First'}
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('stepContent').innerHTML = html;
        }

        function selectConflictOption(conflictId, factId) {
            const conflict = projectState.conflictsData.find(c => c.id === conflictId);
            if (conflict) {
                conflict.selectedFactId = factId;
                saveProjectState();
                renderStep2();
            }
        }

        function resolveAllConflicts() {
            projectState.conflictsData.forEach(conflict => {
                const commentEl = document.getElementById(`comment_${conflict.id}`);
                if (commentEl) {
                    conflict.comment = commentEl.value.trim();
                }
                conflict.resolved = true;
            });

            saveProjectState();
            UI.showSuccess('Conflicts Resolved', 'All conflicts resolved successfully!');
            setTimeout(() => completeStep2(), 1000);
        }

        async function completeStep2() {
            UI.showLoader('Generating structured summary...');
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const summary = Summary.generateSummary(projectState.extractionData, projectState.conflictsData);
            projectState.summaryData = summary;
            
            if (!projectState.completedSteps.includes(2)) {
                projectState.completedSteps.push(2);
            }
            projectState.currentStep = 3;
            
            saveProjectState();
            UI.hideLoader();
            renderSteps();
            renderCurrentStep();
        }

        // ==================== STEP 3: EDITABLE SUMMARY ====================
        function renderStep3() {
            const summary = projectState.summaryData;
            
            const html = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-2" style="color: #111827;">Step 3: Summary Review</h2>
                    <p class="mb-6" style="color: #6B7280;">Review and edit the structured summary.</p>
                    
                    <!-- Key Decisions -->
                    <div class="bg-white rounded-lg shadow-sm p-5 border mb-5" style="border-color: #E5E7EB;">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold" style="color: #111827;">Key Decisions</h3>
                            <button onclick="addKeyDecision()" class="text-xs px-2 py-1 border rounded" style="border-color: #E5E7EB; color: #2563EB;">+ Add</button>
                        </div>
                        <div class="space-y-3">
                            ${(summary.keyDecisions || []).map((d, idx) => `
                                <div class="p-3 rounded" style="background-color: #F9FAFB;">
                                    <div class="flex justify-between items-start mb-2">
                                        <input type="text" value="${UI.escapeHtml(d.title)}" 
                                               onchange="updateDecision(${idx}, 'title', this.value)"
                                               class="text-sm font-medium bg-transparent border-0 p-0 w-full focus:ring-0" 
                                               style="color: #111827;">
                                        <button onclick="removeDecision(${idx})" class="text-xs" style="color: #DC2626;">√ó</button>
                                    </div>
                                    <textarea onchange="updateDecision(${idx}, 'description', this.value)"
                                              class="text-sm bg-transparent border-0 p-0 w-full focus:ring-0" 
                                              style="color: #6B7280;" 
                                              rows="2">${UI.escapeHtml(d.description)}</textarea>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Risks -->
                    <div class="bg-white rounded-lg shadow-sm p-5 border mb-5" style="border-color: #E5E7EB;">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold" style="color: #111827;">Risks</h3>
                            <button onclick="addRisk()" class="text-xs px-2 py-1 border rounded" style="border-color: #E5E7EB; color: #2563EB;">+ Add</button>
                        </div>
                        <div class="space-y-3">
                            ${(summary.risks || []).map((r, idx) => `
                                <div class="p-3 rounded" style="background-color: #F9FAFB;">
                                    <div class="flex justify-between items-start gap-2 mb-2">
                                        <input type="text" value="${UI.escapeHtml(r.title)}" 
                                               onchange="updateRisk(${idx}, 'title', this.value)"
                                               class="text-sm font-medium bg-transparent border-0 p-0 flex-1" 
                                               style="color: #111827;">
                                        <select onchange="updateRisk(${idx}, 'severity', this.value)" 
                                                class="text-xs border-0 bg-transparent p-0" 
                                                style="color: ${r.severity === 'High' ? '#DC2626' : r.severity === 'Medium' ? '#EAB308' : '#6B7280'};">
                                            <option value="High" ${r.severity === 'High' ? 'selected' : ''}>High</option>
                                            <option value="Medium" ${r.severity === 'Medium' ? 'selected' : ''}>Medium</option>
                                            <option value="Low" ${r.severity === 'Low' ? 'selected' : ''}>Low</option>
                                        </select>
                                        <button onclick="removeRisk(${idx})" class="text-xs" style="color: #DC2626;">√ó</button>
                                    </div>
                                    <textarea onchange="updateRisk(${idx}, 'description', this.value)"
                                              class="text-sm bg-transparent border-0 p-0 w-full mb-2" 
                                              style="color: #6B7280;" 
                                              rows="2">${UI.escapeHtml(r.description)}</textarea>
                                    <textarea onchange="updateRisk(${idx}, 'mitigation', this.value)"
                                              class="text-sm bg-transparent border-0 p-0 w-full" 
                                              style="color: #6B7280;" 
                                              rows="1">${UI.escapeHtml(r.mitigation)}</textarea>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Requirements -->
                    <div class="bg-white rounded-lg shadow-sm p-5 border mb-5" style="border-color: #E5E7EB;">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold" style="color: #111827;">Requirements</h3>
                            <button onclick="addRequirement()" class="text-xs px-2 py-1 border rounded" style="border-color: #E5E7EB; color: #2563EB;">+ Add</button>
                        </div>
                        <div class="space-y-3">
                            ${(summary.requirements || []).map((r, idx) => `
                                <div class="p-3 rounded" style="background-color: #F9FAFB;">
                                    <div class="flex items-center gap-2 mb-2">
                                        <select onchange="updateRequirement(${idx}, 'type', this.value)" 
                                                class="text-xs border-0 bg-transparent p-0" style="color: #6B7280;">
                                            <option value="Functional" ${r.type === 'Functional' ? 'selected' : ''}>Functional</option>
                                            <option value="Security" ${r.type === 'Security' ? 'selected' : ''}>Security</option>
                                            <option value="Compliance" ${r.type === 'Compliance' ? 'selected' : ''}>Compliance</option>
                                        </select>
                                        <select onchange="updateRequirement(${idx}, 'priority', this.value)" 
                                                class="text-xs border-0 bg-transparent p-0" 
                                                style="color: ${r.priority === 'High' ? '#DC2626' : r.priority === 'Medium' ? '#EAB308' : '#6B7280'};">
                                            <option value="High" ${r.priority === 'High' ? 'selected' : ''}>High</option>
                                            <option value="Medium" ${r.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                            <option value="Low" ${r.priority === 'Low' ? 'selected' : ''}>Low</option>
                                        </select>
                                        <button onclick="removeRequirement(${idx})" class="ml-auto text-xs" style="color: #DC2626;">√ó</button>
                                    </div>
                                    <textarea onchange="updateRequirement(${idx}, 'description', this.value)"
                                              class="text-sm bg-transparent border-0 p-0 w-full" 
                                              style="color: #6B7280;" 
                                              rows="2">${UI.escapeHtml(r.description)}</textarea>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Stakeholders -->
                    <div class="bg-white rounded-lg shadow-sm p-5 border mb-5" style="border-color: #E5E7EB;">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold" style="color: #111827;">Stakeholders</h3>
                            <button onclick="addStakeholder()" class="text-xs px-2 py-1 border rounded" style="border-color: #E5E7EB; color: #2563EB;">+ Add</button>
                        </div>
                        <div class="space-y-3">
                            ${(summary.stakeholders || []).map((s, idx) => `
                                <div class="p-3 rounded" style="background-color: #F9FAFB;">
                                    <div class="flex justify-between items-start mb-2">
                                        <input type="text" value="${UI.escapeHtml(s.name)}" 
                                               onchange="updateStakeholder(${idx}, 'name', this.value)"
                                               class="text-sm font-medium bg-transparent border-0 p-0 flex-1" 
                                               style="color: #111827;">
                                        <button onclick="removeStakeholder(${idx})" class="text-xs" style="color: #DC2626;">√ó</button>
                                    </div>
                                    <input type="text" value="${UI.escapeHtml(s.role)}" 
                                           onchange="updateStakeholder(${idx}, 'role', this.value)"
                                           class="text-sm bg-transparent border-0 p-0 w-full mb-1" 
                                           style="color: #6B7280;">
                                    <textarea onchange="updateStakeholder(${idx}, 'responsibility', this.value)"
                                              class="text-sm bg-transparent border-0 p-0 w-full" 
                                              style="color: #6B7280;" 
                                              rows="1">${UI.escapeHtml(s.responsibility)}</textarea>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button onclick="completeStep3()" class="px-6 py-2.5 rounded-lg text-white text-sm font-medium" style="background-color: #2563EB;">
                            Generate BRD ‚Üí
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('stepContent').innerHTML = html;
        }

        // Edit functions
        function updateDecision(idx, field, value) {
            projectState.summaryData.keyDecisions[idx][field] = value;
            saveProjectState();
        }
        function removeDecision(idx) {
            projectState.summaryData.keyDecisions.splice(idx, 1);
            saveProjectState();
            renderStep3();
        }
        function addKeyDecision() {
            projectState.summaryData.keyDecisions.push({ 
                id: 'decision_' + Date.now(), 
                title: 'New Decision', 
                description: 'Add description' 
            });
            saveProjectState();
            renderStep3();
        }

        function updateRisk(idx, field, value) {
            projectState.summaryData.risks[idx][field] = value;
            saveProjectState();
        }
        function removeRisk(idx) {
            projectState.summaryData.risks.splice(idx, 1);
            saveProjectState();
            renderStep3();
        }
        function addRisk() {
            projectState.summaryData.risks.push({ 
                id: 'risk_' + Date.now(), 
                title: 'New Risk', 
                severity: 'Medium',
                description: 'Add description',
                mitigation: 'Add mitigation'
            });
            saveProjectState();
            renderStep3();
        }

        function updateRequirement(idx, field, value) {
            projectState.summaryData.requirements[idx][field] = value;
            saveProjectState();
        }
        function removeRequirement(idx) {
            projectState.summaryData.requirements.splice(idx, 1);
            saveProjectState();
            renderStep3();
        }
        function addRequirement() {
            projectState.summaryData.requirements.push({ 
                id: 'req_' + Date.now(), 
                type: 'Functional',
                priority: 'Medium',
                description: 'Add requirement description'
            });
            saveProjectState();
            renderStep3();
        }

        function updateStakeholder(idx, field, value) {
            projectState.summaryData.stakeholders[idx][field] = value;
            saveProjectState();
        }
        function removeStakeholder(idx) {
            projectState.summaryData.stakeholders.splice(idx, 1);
            saveProjectState();
            renderStep3();
        }
        function addStakeholder() {
            projectState.summaryData.stakeholders.push({ 
                id: 'stakeholder_' + Date.now(), 
                name: 'New Stakeholder',
                role: 'Role',
                responsibility: 'Responsibility'
            });
            saveProjectState();
            renderStep3();
        }

        async function completeStep3() {
            UI.showLoader('Generating BRD...');
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const brd = BRD.generateBRD(projectState.summaryData, currentProject.name, testUserData);
            projectState.brdData = brd;
            
            if (!projectState.completedSteps.includes(3)) {
                projectState.completedSteps.push(3);
            }
            projectState.currentStep = 4;
            
            saveProjectState();
            UI.hideLoader();
            renderSteps();
            renderCurrentStep();
        }

        // ==================== STEP 4: BRD DOCUMENT ====================
        function renderStep4() {
            const brd = projectState.brdData;
            
            // Generate MDX content
            const mdxContent = MDXRenderer.generateMDXContent(brd);
            const htmlContent = MDXRenderer.renderMDXAsHTML(mdxContent);
            
            const html = `
                <div class="max-w-6xl mx-auto">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2" style="color: #111827;">Step 4: BRD Document</h2>
                        <p class="mb-4" style="color: #6B7280;">Your Business Requirements Document is ready. View, edit, or export it below.</p>
                        
                        <div class="flex flex-wrap gap-3 mb-4">
                            <button onclick="downloadPDFFile()" class="px-4 py-2 rounded-lg text-white text-sm font-medium" style="background-color: #DC2626;">
                                üìä Download as PDF
                            </button>
                            <button onclick="downloadMDXFile()" class="px-4 py-2 rounded-lg text-white text-sm font-medium" style="background-color: #2563EB;">
                                üì• Download as MDX
                            </button>
                            <button onclick="downloadMarkdownFile()" class="px-4 py-2 rounded-lg text-white text-sm font-medium" style="background-color: #0891b2;">
                                üìÑ Download as Markdown
                            </button>
                            <button onclick="copyMDXToClipboard()" class="px-4 py-2 rounded-lg text-white text-sm font-medium" style="background-color: #16A34A;">
                                üìã Copy MDX
                            </button>
                        </div>
                    </div>

                    <!-- MDX Preview -->
                    <div class="bg-white rounded-lg shadow-sm border p-8" style="border-color: #E5E7EB;">
                        ${htmlContent}
                    </div>

                    <div class="mt-8 flex justify-center gap-3">
                        <button onclick="backToStep3()" class="px-5 py-2 rounded-lg text-sm font-medium" style="border: 1px solid #E5E7EB; color: #6B7280;">
                            ‚Üê Back to Summary
                        </button>
                        <button onclick="finalizeBRD()" class="px-5 py-2 rounded-lg text-white text-sm font-medium" style="background-color: #16A34A;">
                            ‚úì Complete Project
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('stepContent').innerHTML = html;
        }

        async function downloadPDFFile() {
            const brd = projectState.brdData;
            await PDFExporter.exportBRDToPDF(brd, currentProject.name);
        }

        function downloadMDXFile() {
            const brd = projectState.brdData;
            const mdxContent = MDXRenderer.generateMDXContent(brd);
            const blob = MDXRenderer.getMDXBlob(mdxContent);
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentProject.name.replace(/\s+/g, '-').toLowerCase()}-brd.mdx`;
            link.click();
            URL.revokeObjectURL(url);
            UI.showSuccess('Downloaded', 'BRD exported as MDX file.');
        }

        function downloadMarkdownFile() {
            const brd = projectState.brdData;
            const mdContent = MDXRenderer.generateMDXContent(brd);
            const blob = new Blob([mdContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentProject.name.replace(/\s+/g, '-').toLowerCase()}-brd.md`;
            link.click();
            URL.revokeObjectURL(url);
            UI.showSuccess('Downloaded', 'BRD exported as Markdown file.');
        }

        function copyMDXToClipboard() {
            const brd = projectState.brdData;
            const mdxContent = MDXRenderer.generateMDXContent(brd);
            navigator.clipboard.writeText(mdxContent).then(() => {
                UI.showSuccess('Copied', 'MDX content copied to clipboard!');
            }).catch(() => {
                UI.showError('Error', 'Failed to copy to clipboard.');
            });
        }

        function backToStep3() {
            projectState.currentStep = 3;
            saveProjectState();
            renderSteps();
            renderCurrentStep();
        }

        function finalizeBRD() {
            UI.showConfirmation(
                'Complete Project',
                'Are you sure you want to mark this project as complete? You can still edit and export the BRD later.',
                () => {
                    if (!projectState.completedSteps.includes(4)) {
                        projectState.completedSteps.push(4);
                    }
                    currentProject.status = 'completed';
                    currentProject.completedDate = new Date().toISOString();
                    saveProjectState();
                    UI.showSuccess('Project Complete', 'Your BRD has been finalized!');
                    setTimeout(() => {
                        window.location.href = 'user-dashboard.html';
                    }, 2000);
                }
            );
        }

        // Save project state
        function saveProjectState() {
            currentProject.lastModified = new Date().toISOString();
            currentProject.currentStep = projectState.currentStep;
            currentProject.completedSteps = projectState.completedSteps;
            
            projectState.metadata = currentProject;
            Storage.set(Storage.KEYS.PROJECT_PREFIX + currentProject.id, projectState);
            
            let projects = Storage.get(Storage.KEYS.USER_PROJECTS) || [];
            const index = projects.findIndex(p => p.id === currentProject.id);
            if (index >= 0) {
                projects[index] = currentProject;
                Storage.set(Storage.KEYS.USER_PROJECTS, projects);
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
